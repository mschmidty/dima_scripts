---
title: "Untitled"
author: "Mike Schmidt"
date: "August 30, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This R file determines species richness and parses all plants found to make a complete plant list. 

## Load libraries

you must have devtools installed to get dima.tools from [here](https://github.com/nstauffer/dima.tools).  
```{r}
##Load Libraries - May need to intall these with install.packages() before loading.
library(RODBC) ## - for reading Access Databases
library(tidyverse)
library(dima.tools)
library(data.table)
library(stringr)
library(ggthemes)
```

## Load the DIMA database. 
You can either use read.dima, as I do here. Or you can use the RODBC package like so `odbcDriverConnect("Driver={Microsoft Access Driver (*.mdb, *.accdb)};DBQ=database/8_30.mdb")`.  **Note that you must be using 32 bit version of R to connect to an Access Database (either method).** to change your r version, go to `Tools>Global Options` and under the `General` tab, select `change` under the "R version" section. 

```{r}
dima<-read.dima("database", all.tables = T)
```


## find the species richness table.
```{r}
species_rich_details<-dima$tblSpecRichDetail
species_rich_details
```


## Subset the species list
We have a lot of blank rows, to iliminate those I added the `filter()` function to eliminate all of the rows with no plants. 

```{r}
all_species<-species_rich_details %>%
  filter(SpeciesCount>0)%>%
  select(SpeciesList)%>%
  separate_rows(SpeciesList, convert=T)

View(all_species)
  

```

##Count each occurrent with `table()`

```{r}
count<-as.data.frame(table(all_species$SpeciesList))
count
final_list<-count%>%
  rename(symbol=1, count=2)
final_list<-final_list[-1, ]
final_list
```


## Load and Merge with the plant list for Colorado

Read the Plant List
```{r}
plant_list<-read_csv("COplants5312018.txt")
plant_list
```

Clean and Merge
```{r}
plant_list_cl<- plant_list%>%
  rename(symbol=1, sci_name=3)

plant_list_cl<-plant_list_cl[match(unique(plant_list_cl$symbol), plant_list_cl$symbol),]
plant_list_cl
```

Join the tables
```{r}
final_merged_list<-final_list %>%
  left_join(plant_list_cl)%>%
  rename(num_occur=count, common_name=5)%>%
  select(-3)
final_merged_list
```





## Write the File

```{r}
write_csv(final_merged_list, "output/species_richness_plant_list_09252018.csv")

```


## Plot

### get rid of unknowns
```{r}
for_plot_cl<-final_merged_list%>%
  filter(!str_detect(symbol, "AF"), !str_detect(symbol,"AG01"), !str_detect(symbol,"PF"), !str_detect(symbol, "PG"), !str_detect(symbol, "SH"), !str_detect(symbol,"SU"))%>%
  arrange(desc(symbol))
for_plot_cl
```

```{r}
ggplot(for_plot_cl, aes(reorder(symbol, num_occur), num_occur))+
  coord_flip()+
  theme_minimal()+
  geom_col(fill = "#581845")

ggsave("output/frequency_by_symbol.jpg", width = 4, height = 20, units = "in")
```




##Merge With Growth Type and Write to a file
```{r}
plant_growth<-read_csv("plant_list_with_growth_habit.csv")
plant_growth<-rename(plant_growth, symbol=Symbol)
merged_plant_growth_species_richness<-for_plot_cl%>% left_join(plant_growth)%>%
  select(symbol:sci_name, Family, "Growth Habit" )
merged_plant_growth_species_richness
write_csv(merged_plant_growth_species_richness, "output/species_richenss_w_growth_habit09252018.csv")
```



